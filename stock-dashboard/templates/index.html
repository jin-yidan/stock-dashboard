{% extends "base.html" %}

{% block content %}
<!-- Main Content -->
<div class="home-page">
    <div class="home-container">
        <!-- Page Header -->
        <header class="page-header">
            <h1 class="page-title">股票查询</h1>
            <p class="page-subtitle">搜索 A 股代码或名称，查看实时行情与技术分析</p>
        </header>

        <!-- Search -->
        <div class="search-section">
            <form onsubmit="return go()" class="search-form">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="code" class="search-input" placeholder="输入代码或名称" autofocus>
                </div>
            </form>
            <div id="hero-search-results" class="search-dropdown"></div>
        </div>

        <!-- Watchlist -->
        <section class="watchlist-section">
            <div class="section-header">
                <h2 class="section-title">自选股</h2>
                <button class="btn-add-stock" onclick="showAddModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    添加
                </button>
            </div>

            <!-- Table Header -->
            <div class="stock-table-header">
                <span class="col-name">名称</span>
                <span class="col-price">现价</span>
                <span class="col-change">涨跌幅</span>
                <span class="col-action"></span>
            </div>

            <div id="watchlist" class="stock-table">
                <!-- Populated by JS -->
            </div>
            <div id="empty-msg" class="empty-state" style="display:none;">
                <p>暂无自选股</p>
                <button class="btn-add-empty" onclick="showAddModal()">添加第一只股票</button>
            </div>
        </section>
    </div>
</div>

<!-- Add Stock Modal -->
<div id="add-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div class="modal-header">
            <span>添加自选股</span>
            <button onclick="hideAddModal()" class="modal-close">&times;</button>
        </div>
        <input type="text" id="search-input" class="stock-input" placeholder="输入代码或名称" oninput="searchStocks()">
        <div id="modal-search-results" class="modal-results"></div>
        <p class="text-secondary small mt-3">常用股票</p>
        <div class="quick-add-grid">
            {% for stock in hot_stocks %}
            <button class="quick-add-btn" onclick="addToWatchlist('{{ stock.stock_code }}', '{{ stock.short_name }}')">
                <span class="code">{{ stock.stock_code }}</span>
                <span class="name">{{ stock.short_name }}</span>
            </button>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('code').focus();

// HTML escape helper to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Fetch with timeout helper
function fetchWithTimeout(url, options = {}, timeout = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    return fetch(url, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(timeoutId));
}

let heroSearchTimeout;
const codeInput = document.getElementById('code');

// Live search as user types
codeInput.addEventListener('input', function() {
    const q = this.value.trim();
    clearTimeout(heroSearchTimeout);

    // If it's a 6-digit code, no need to search
    if (/^\d{6}$/.test(q)) {
        document.getElementById('hero-search-results').innerHTML = '';
        return;
    }

    if (q.length < 1) {
        document.getElementById('hero-search-results').innerHTML = '';
        return;
    }

    heroSearchTimeout = setTimeout(() => {
        fetchWithTimeout('/api/search?q=' + encodeURIComponent(q), {}, 5000)
            .then(r => r.json())
            .then(data => {
                if (data.length === 0) {
                    document.getElementById('hero-search-results').innerHTML = '';
                    return;
                }
                const html = data.slice(0, 5).map(s => `
                    <a href="/stock/${escapeHtml(s.stock_code)}" class="hero-result-item">
                        <span class="result-name">${escapeHtml(s.short_name)}</span>
                        <span class="result-code">${escapeHtml(s.stock_code)}</span>
                    </a>
                `).join('');
                document.getElementById('hero-search-results').innerHTML = html;
            })
            .catch(err => {
                console.error('Search error:', err);
            });
    }, 150);
});

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-box') && !e.target.closest('.hero-results')) {
        document.getElementById('hero-search-results').innerHTML = '';
    }
});

function go() {
    const c = document.getElementById('code').value.trim();
    // If 6-digit code, go directly
    if (/^\d{6}$/.test(c)) {
        location.href = '/stock/' + c;
        return false;
    }
    // Otherwise, search and go to first result
    fetch('/api/search?q=' + encodeURIComponent(c))
        .then(r => r.json())
        .then(data => {
            if (data.length > 0) {
                location.href = '/stock/' + data[0].stock_code;
            }
        });
    return false;
}

// Watchlist functions
function getWatchlist() {
    const data = localStorage.getItem('watchlist');
    return data ? JSON.parse(data) : [];
}

function saveWatchlist(list) {
    localStorage.setItem('watchlist', JSON.stringify(list));
}

// Quote cache functions
function getQuoteCache() {
    const data = localStorage.getItem('quoteCache');
    return data ? JSON.parse(data) : {};
}

function saveQuoteCache(code, quote) {
    const cache = getQuoteCache();
    cache[code] = { ...quote, timestamp: Date.now() };
    localStorage.setItem('quoteCache', JSON.stringify(cache));
}

function getCachedQuote(code) {
    const cache = getQuoteCache();
    const cached = cache[code];
    // Cache valid for 10 minutes
    if (cached && (Date.now() - cached.timestamp) < 600000) {
        return cached;
    }
    return null;
}

function renderQuoteHtml(data) {
    if (!data || data.error || !data.price) {
        return { price: '--', pct: '--', pctClass: '' };
    }
    const pctClass = data.change_pct >= 0 ? 'up' : 'down';
    const prefix = data.change_pct >= 0 ? '+' : '';
    return {
        price: data.price.toFixed(2),
        pct: prefix + data.change_pct.toFixed(2) + '%',
        pctClass: pctClass
    };
}

function renderWatchlist() {
    const list = getWatchlist();
    const container = document.getElementById('watchlist');
    const emptyMsg = document.getElementById('empty-msg');

    if (list.length === 0) {
        container.innerHTML = '';
        emptyMsg.style.display = 'flex';
        return;
    }

    emptyMsg.style.display = 'none';

    // Render with cached quotes immediately
    container.innerHTML = list.map(s => {
        const cached = getCachedQuote(s.code);
        const quote = cached ? renderQuoteHtml(cached) : { price: '--', pct: '--', pctClass: '' };
        const safeCode = escapeHtml(s.code);
        const safeName = escapeHtml(s.name);
        return `
            <a href="/stock/${safeCode}" class="stock-row" id="stock-${safeCode}" onmouseenter="preloadStock('${safeCode}')">
                <span class="col-name">
                    <span class="stock-name">${safeName}</span>
                    <span class="stock-code">${safeCode}</span>
                </span>
                <span class="col-price" id="price-${safeCode}">${quote.price}</span>
                <span class="col-change ${quote.pctClass}" id="pct-${safeCode}">${quote.pct}</span>
                <span class="col-action">
                    <button class="btn-remove" onclick="event.preventDefault();event.stopPropagation();removeFromWatchlist('${safeCode}')" title="移除">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </span>
            </a>
        `;
    }).join('');

    // Refresh quotes in background
    loadWatchlistQuotes(list);
}

function loadWatchlistQuotes(list) {
    if (list.length === 0) return;

    // Use batch API for better performance
    const codes = list.map(s => s.code).join(',');
    fetchWithTimeout('/api/quotes/batch?codes=' + encodeURIComponent(codes), {}, 10000)
        .then(r => r.json())
        .then(data => {
            const quotes = data.quotes || {};
            list.forEach(s => {
                const quoteData = quotes[s.code];
                if (quoteData && !quoteData.error && quoteData.price) {
                    saveQuoteCache(s.code, quoteData);
                }
                const quote = renderQuoteHtml(quoteData);
                const priceEl = document.getElementById('price-' + s.code);
                const pctEl = document.getElementById('pct-' + s.code);
                if (priceEl) priceEl.textContent = quote.price;
                if (pctEl) {
                    pctEl.textContent = quote.pct;
                    pctEl.className = 'col-change ' + quote.pctClass;
                }
            });
        })
        .catch(() => {
            // Fallback: show cached or error state
            list.forEach(s => {
                const priceEl = document.getElementById('price-' + s.code);
                const pctEl = document.getElementById('pct-' + s.code);
                if (priceEl) priceEl.textContent = '--';
                if (pctEl) { pctEl.textContent = '--'; pctEl.className = 'col-change'; }
            });
        });
}

function addToWatchlist(code, name) {
    const list = getWatchlist();
    if (!list.find(s => s.code === code)) {
        list.unshift({ code, name });
        saveWatchlist(list);
        // Only add the new stock element instead of re-rendering everything
        addStockElement(code, name, true);
    }
    hideAddModal();
}

function addStockElement(code, name, prepend = false) {
    const container = document.getElementById('watchlist');
    const emptyMsg = document.getElementById('empty-msg');
    emptyMsg.style.display = 'none';

    const cached = getCachedQuote(code);
    const quote = cached ? renderQuoteHtml(cached) : { price: '--', pct: '--', pctClass: '' };

    const a = document.createElement('a');
    a.href = '/stock/' + code;
    a.className = 'stock-row';
    a.id = 'stock-' + code;
    a.onmouseenter = () => preloadStock(code);
    a.innerHTML = `
        <span class="col-name">
            <span class="stock-name">${escapeHtml(name)}</span>
            <span class="stock-code">${escapeHtml(code)}</span>
        </span>
        <span class="col-price" id="price-${escapeHtml(code)}">${quote.price}</span>
        <span class="col-change ${quote.pctClass}" id="pct-${escapeHtml(code)}">${quote.pct}</span>
        <span class="col-action">
            <button class="btn-remove" onclick="event.preventDefault();event.stopPropagation();removeFromWatchlist('${escapeHtml(code)}')" title="移除">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </span>
    `;

    if (prepend && container.firstChild) {
        container.insertBefore(a, container.firstChild);
    } else {
        container.appendChild(a);
    }

    // Load fresh quote
    loadSingleQuote(code);
}

function loadSingleQuote(code) {
    fetch('/api/stock/' + code + '/quote')
        .then(r => r.json())
        .then(data => {
            if (!data.error && data.price) {
                saveQuoteCache(code, data);
            }
            const quote = renderQuoteHtml(data);
            const priceEl = document.getElementById('price-' + code);
            const pctEl = document.getElementById('pct-' + code);
            if (priceEl) priceEl.textContent = quote.price;
            if (pctEl) {
                pctEl.textContent = quote.pct;
                pctEl.className = 'col-change ' + quote.pctClass;
            }
        })
        .catch(() => {
            const priceEl = document.getElementById('price-' + code);
            const pctEl = document.getElementById('pct-' + code);
            if (priceEl) priceEl.textContent = '--';
            if (pctEl) { pctEl.textContent = '--'; pctEl.className = 'col-change'; }
        });
}

// Preload stock data on hover for faster navigation
const preloadedStocks = new Set();
function preloadStock(code) {
    if (preloadedStocks.has(code)) return;
    preloadedStocks.add(code);
    // Preload signal data (the slowest API)
    fetch('/api/stock/' + code + '/signal');
    // Preload kline data
    fetch('/api/stock/' + code + '/kline?days=60');
}

function removeFromWatchlist(code) {
    const list = getWatchlist().filter(s => s.code !== code);
    saveWatchlist(list);
    // Only remove the specific element instead of re-rendering
    const el = document.getElementById('stock-' + code);
    if (el) el.remove();
    // Show empty message if no stocks left
    if (list.length === 0) {
        document.getElementById('empty-msg').style.display = 'block';
    }
}

// Modal functions
function showAddModal() {
    document.getElementById('add-modal').style.display = 'flex';
    document.getElementById('search-input').value = '';
    document.getElementById('modal-search-results').innerHTML = '';
    document.getElementById('search-input').focus();
}

function hideAddModal() {
    document.getElementById('add-modal').style.display = 'none';
}

let searchTimeout;
function searchStocks() {
    const q = document.getElementById('search-input').value.trim();
    clearTimeout(searchTimeout);
    if (q.length < 1) {
        document.getElementById('modal-search-results').innerHTML = '';
        return;
    }
    searchTimeout = setTimeout(() => {
        fetchWithTimeout('/api/search?q=' + encodeURIComponent(q), {}, 5000)
            .then(r => r.json())
            .then(data => {
                const html = data.map(s => {
                    const safeCode = escapeHtml(s.stock_code);
                    const safeName = escapeHtml(s.short_name);
                    return `
                        <button class="search-result-item" onclick="addToWatchlist('${safeCode}', '${safeName}')">
                            <span class="code">${safeCode}</span>
                            <span class="name">${safeName}</span>
                        </button>
                    `;
                }).join('');
                document.getElementById('modal-search-results').innerHTML = html || '<p class="text-secondary small">未找到</p>';
            })
            .catch(err => {
                console.error('Modal search error:', err);
            });
    }, 200);
}

// Close modal on escape or click outside
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideAddModal();
});
document.getElementById('add-modal').addEventListener('click', e => {
    if (e.target.id === 'add-modal') hideAddModal();
});

// Auto-refresh quotes every 30 seconds during market hours
function isMarketHours() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    // Monday-Friday, 9:30-15:00 China time
    if (day === 0 || day === 6) return false;
    const time = hour * 100 + minute;
    return (time >= 930 && time <= 1130) || (time >= 1300 && time <= 1500);
}

function startAutoRefresh() {
    if (isMarketHours()) {
        setInterval(() => {
            const list = getWatchlist();
            if (list.length > 0) {
                loadWatchlistQuotes(list);
            }
        }, 30000); // Refresh every 30 seconds
    }
}

// Initialize
renderWatchlist();
startAutoRefresh();
</script>
{% endblock %}
