{% extends "base.html" %}

{% block content %}
<!-- Main Content -->
<div class="main-container">
    <!-- Search -->
    <div class="search-wrapper">
        <form onsubmit="return go()">
            <input type="text" id="code" class="main-search" placeholder="输入股票代码或名称，如 600519 或 茅台" autofocus>
        </form>
        <div id="hero-search-results" class="search-dropdown"></div>
    </div>

    <!-- Watchlist -->
    <div class="watchlist-wrapper">
        <div class="watchlist-header">
            <h2>自选股</h2>
            <button class="add-btn" onclick="showAddModal()">+ 添加</button>
        </div>
        <div id="watchlist" class="stock-list">
            <!-- Populated by JS -->
        </div>
        <p id="empty-msg" class="empty-hint" style="display:none;">
            暂无自选股，点击"添加"按钮添加
        </p>
    </div>
</div>

<!-- Add Stock Modal -->
<div id="add-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div class="modal-header">
            <span>添加自选股</span>
            <button onclick="hideAddModal()" class="modal-close">&times;</button>
        </div>
        <input type="text" id="search-input" class="stock-input" placeholder="输入代码或名称" oninput="searchStocks()">
        <div id="modal-search-results" class="modal-results"></div>
        <p class="text-secondary small mt-3">常用股票</p>
        <div class="quick-add-grid">
            {% for stock in hot_stocks %}
            <button class="quick-add-btn" onclick="addToWatchlist('{{ stock.stock_code }}', '{{ stock.short_name }}')">
                <span class="code">{{ stock.stock_code }}</span>
                <span class="name">{{ stock.short_name }}</span>
            </button>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('code').focus();

let heroSearchTimeout;
const codeInput = document.getElementById('code');

// Live search as user types
codeInput.addEventListener('input', function() {
    const q = this.value.trim();
    clearTimeout(heroSearchTimeout);

    // If it's a 6-digit code, no need to search
    if (/^\d{6}$/.test(q)) {
        document.getElementById('hero-search-results').innerHTML = '';
        return;
    }

    if (q.length < 1) {
        document.getElementById('hero-search-results').innerHTML = '';
        return;
    }

    heroSearchTimeout = setTimeout(() => {
        fetch('/api/search?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
                if (data.length === 0) {
                    document.getElementById('hero-search-results').innerHTML = '';
                    return;
                }
                const html = data.slice(0, 5).map(s => `
                    <a href="/stock/${s.stock_code}" class="hero-result-item">
                        <span class="result-name">${s.short_name}</span>
                        <span class="result-code">${s.stock_code}</span>
                    </a>
                `).join('');
                document.getElementById('hero-search-results').innerHTML = html;
            });
    }, 150);
});

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-box') && !e.target.closest('.hero-results')) {
        document.getElementById('hero-search-results').innerHTML = '';
    }
});

function go() {
    const c = document.getElementById('code').value.trim();
    // If 6-digit code, go directly
    if (/^\d{6}$/.test(c)) {
        location.href = '/stock/' + c;
        return false;
    }
    // Otherwise, search and go to first result
    fetch('/api/search?q=' + encodeURIComponent(c))
        .then(r => r.json())
        .then(data => {
            if (data.length > 0) {
                location.href = '/stock/' + data[0].stock_code;
            }
        });
    return false;
}

// Watchlist functions
function getWatchlist() {
    const data = localStorage.getItem('watchlist');
    return data ? JSON.parse(data) : [];
}

function saveWatchlist(list) {
    localStorage.setItem('watchlist', JSON.stringify(list));
}

// Quote cache functions
function getQuoteCache() {
    const data = localStorage.getItem('quoteCache');
    return data ? JSON.parse(data) : {};
}

function saveQuoteCache(code, quote) {
    const cache = getQuoteCache();
    cache[code] = { ...quote, timestamp: Date.now() };
    localStorage.setItem('quoteCache', JSON.stringify(cache));
}

function getCachedQuote(code) {
    const cache = getQuoteCache();
    const cached = cache[code];
    // Cache valid for 10 minutes
    if (cached && (Date.now() - cached.timestamp) < 600000) {
        return cached;
    }
    return null;
}

function renderQuoteHtml(data) {
    if (!data || data.error || !data.price) {
        return '<span class="quote-na">--</span>';
    }
    const pctClass = data.change_pct >= 0 ? 'up' : 'down';
    const prefix = data.change_pct >= 0 ? '+' : '';
    return `
        <span class="quote-price ${pctClass}">${data.price.toFixed(2)}</span>
        <span class="quote-pct ${pctClass}">${prefix}${data.change_pct.toFixed(2)}%</span>
    `;
}

function renderWatchlist() {
    const list = getWatchlist();
    const container = document.getElementById('watchlist');
    const emptyMsg = document.getElementById('empty-msg');

    if (list.length === 0) {
        container.innerHTML = '';
        emptyMsg.style.display = 'block';
        return;
    }

    emptyMsg.style.display = 'none';

    // Render with cached quotes immediately
    container.innerHTML = list.map(s => {
        const cached = getCachedQuote(s.code);
        const quoteHtml = cached ? renderQuoteHtml(cached) : '<span class="quote-loading">--</span>';
        return `
            <a href="/stock/${s.code}" class="stock-item" id="stock-${s.code}" onmouseenter="preloadStock('${s.code}')">
                <div class="stock-info">
                    <span class="stock-name">${s.name}</span>
                    <span class="stock-code">${s.code}</span>
                </div>
                <div class="stock-price" id="quote-${s.code}">${quoteHtml}</div>
                <button class="remove-btn" onclick="event.preventDefault();event.stopPropagation();removeFromWatchlist('${s.code}')" title="移除">×</button>
            </a>
        `;
    }).join('');

    // Refresh quotes in background
    loadWatchlistQuotes(list);
}

function loadWatchlistQuotes(list) {
    list.forEach(s => {
        fetch('/api/stock/' + s.code + '/quote')
            .then(r => r.json())
            .then(data => {
                if (!data.error && data.price) {
                    saveQuoteCache(s.code, data);
                }
                const el = document.getElementById('quote-' + s.code);
                if (el) el.innerHTML = renderQuoteHtml(data);
            })
            .catch(() => {
                const el = document.getElementById('quote-' + s.code);
                if (el) el.innerHTML = '<span class="quote-na">--</span>';
            });
    });
}

function addToWatchlist(code, name) {
    const list = getWatchlist();
    if (!list.find(s => s.code === code)) {
        list.unshift({ code, name });
        saveWatchlist(list);
        // Only add the new stock element instead of re-rendering everything
        addStockElement(code, name, true);
    }
    hideAddModal();
}

function addStockElement(code, name, prepend = false) {
    const container = document.getElementById('watchlist');
    const emptyMsg = document.getElementById('empty-msg');
    emptyMsg.style.display = 'none';

    const cached = getCachedQuote(code);
    const quoteHtml = cached ? renderQuoteHtml(cached) : '<span class="quote-loading">--</span>';

    const a = document.createElement('a');
    a.href = '/stock/' + code;
    a.className = 'stock-item';
    a.id = 'stock-' + code;
    a.onmouseenter = () => preloadStock(code);
    a.innerHTML = `
        <div class="stock-info">
            <span class="stock-name">${name}</span>
            <span class="stock-code">${code}</span>
        </div>
        <div class="stock-price" id="quote-${code}">${quoteHtml}</div>
        <button class="remove-btn" onclick="event.preventDefault();event.stopPropagation();removeFromWatchlist('${code}')" title="移除">×</button>
    `;

    if (prepend && container.firstChild) {
        container.insertBefore(a, container.firstChild);
    } else {
        container.appendChild(a);
    }

    // Load fresh quote
    loadSingleQuote(code);
}

function loadSingleQuote(code) {
    fetch('/api/stock/' + code + '/quote')
        .then(r => r.json())
        .then(data => {
            if (!data.error && data.price) {
                saveQuoteCache(code, data);
            }
            const el = document.getElementById('quote-' + code);
            if (el) el.innerHTML = renderQuoteHtml(data);
        })
        .catch(() => {
            const el = document.getElementById('quote-' + code);
            if (el) el.innerHTML = '<span class="quote-na">--</span>';
        });
}

// Preload stock data on hover for faster navigation
const preloadedStocks = new Set();
function preloadStock(code) {
    if (preloadedStocks.has(code)) return;
    preloadedStocks.add(code);
    // Preload signal data (the slowest API)
    fetch('/api/stock/' + code + '/signal');
    // Preload kline data
    fetch('/api/stock/' + code + '/kline?days=60');
}

function removeFromWatchlist(code) {
    const list = getWatchlist().filter(s => s.code !== code);
    saveWatchlist(list);
    // Only remove the specific element instead of re-rendering
    const el = document.getElementById('stock-' + code);
    if (el) el.remove();
    // Show empty message if no stocks left
    if (list.length === 0) {
        document.getElementById('empty-msg').style.display = 'block';
    }
}

// Modal functions
function showAddModal() {
    document.getElementById('add-modal').style.display = 'flex';
    document.getElementById('search-input').value = '';
    document.getElementById('modal-search-results').innerHTML = '';
    document.getElementById('search-input').focus();
}

function hideAddModal() {
    document.getElementById('add-modal').style.display = 'none';
}

let searchTimeout;
function searchStocks() {
    const q = document.getElementById('search-input').value.trim();
    clearTimeout(searchTimeout);
    if (q.length < 1) {
        document.getElementById('modal-search-results').innerHTML = '';
        return;
    }
    searchTimeout = setTimeout(() => {
        fetch('/api/search?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
                const html = data.map(s => `
                    <button class="search-result-item" onclick="addToWatchlist('${s.stock_code}', '${s.short_name}')">
                        <span class="code">${s.stock_code}</span>
                        <span class="name">${s.short_name}</span>
                    </button>
                `).join('');
                document.getElementById('modal-search-results').innerHTML = html || '<p class="text-secondary small">未找到</p>';
            });
    }, 200);
}

// Close modal on escape or click outside
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideAddModal();
});
document.getElementById('add-modal').addEventListener('click', e => {
    if (e.target.id === 'add-modal') hideAddModal();
});

// Auto-refresh quotes every 30 seconds during market hours
function isMarketHours() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    // Monday-Friday, 9:30-15:00 China time
    if (day === 0 || day === 6) return false;
    const time = hour * 100 + minute;
    return (time >= 930 && time <= 1130) || (time >= 1300 && time <= 1500);
}

function startAutoRefresh() {
    if (isMarketHours()) {
        setInterval(() => {
            const list = getWatchlist();
            if (list.length > 0) {
                loadWatchlistQuotes(list);
            }
        }, 30000); // Refresh every 30 seconds
    }
}

// Initialize
renderWatchlist();
startAutoRefresh();
</script>
{% endblock %}
