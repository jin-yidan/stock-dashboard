{% extends "base.html" %}

{% block title %}价格提醒{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <a href="/" class="back-link">← 返回</a>
            <h1 class="mt-3">价格提醒</h1>
            <p class="text-secondary">设置股票价格提醒，突破时浏览器通知</p>
        </div>
    </div>

    <!-- Notification Permission -->
    <div id="permission-box" class="alert-permission-box mb-4" style="display:none;">
        <p>需要开启浏览器通知权限才能收到提醒</p>
        <button onclick="requestPermission()" class="btn btn-primary">开启通知</button>
    </div>

    <!-- Add Alert Form -->
    <div class="alert-form-box mb-4">
        <h3 class="mb-3">添加提醒</h3>
        <form onsubmit="return addAlert()">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">股票代码</label>
                    <input type="text" id="alert-code" class="form-control" placeholder="如 600519" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">条件</label>
                    <select id="alert-condition" class="form-select">
                        <option value="above">高于</option>
                        <option value="below">低于</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">目标价格</label>
                    <input type="number" id="alert-price" class="form-control" step="0.01" placeholder="如 1500.00" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">添加</button>
                </div>
            </div>
        </form>
        <p class="text-secondary small mt-2" id="current-price-hint"></p>
    </div>

    <!-- Active Alerts -->
    <div class="alerts-list-box">
        <h3 class="mb-3">当前提醒</h3>
        <div id="alerts-list">
            <p class="text-secondary">暂无提醒</p>
        </div>
    </div>

    <!-- Triggered History -->
    <div class="alerts-history-box mt-4">
        <h3 class="mb-3">已触发</h3>
        <div id="alerts-history">
            <p class="text-secondary">暂无记录</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Check notification permission
function checkPermission() {
    if (!('Notification' in window)) {
        document.getElementById('permission-box').innerHTML = '<p class="text-secondary">您的浏览器不支持通知功能</p>';
        document.getElementById('permission-box').style.display = 'block';
        return false;
    }

    if (Notification.permission === 'default') {
        document.getElementById('permission-box').style.display = 'block';
        return false;
    }

    if (Notification.permission === 'denied') {
        document.getElementById('permission-box').innerHTML = '<p class="text-secondary">通知已被禁用，请在浏览器设置中开启</p>';
        document.getElementById('permission-box').style.display = 'block';
        return false;
    }

    return true;
}

function requestPermission() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            document.getElementById('permission-box').style.display = 'none';
            new Notification('通知已开启', { body: '您将收到价格提醒通知' });
        }
    });
}

// Alert storage
function getAlerts() {
    const data = localStorage.getItem('priceAlerts');
    return data ? JSON.parse(data) : [];
}

function saveAlerts(alerts) {
    localStorage.setItem('priceAlerts', JSON.stringify(alerts));
}

function getHistory() {
    const data = localStorage.getItem('alertHistory');
    return data ? JSON.parse(data) : [];
}

function saveHistory(history) {
    localStorage.setItem('alertHistory', JSON.stringify(history.slice(0, 20))); // Keep last 20
}

// Add new alert
function addAlert() {
    const code = document.getElementById('alert-code').value.trim();
    const condition = document.getElementById('alert-condition').value;
    const price = parseFloat(document.getElementById('alert-price').value);

    if (!/^\d{6}$/.test(code)) {
        alert('请输入6位股票代码');
        return false;
    }

    // Get stock name
    fetch('/api/stock/' + code + '/info')
        .then(r => r.json())
        .then(data => {
            const alerts = getAlerts();
            alerts.push({
                id: Date.now(),
                code: code,
                name: data.short_name || code,
                condition: condition,
                price: price,
                created: new Date().toISOString()
            });
            saveAlerts(alerts);
            renderAlerts();

            // Clear form
            document.getElementById('alert-code').value = '';
            document.getElementById('alert-price').value = '';
        });

    return false;
}

function removeAlert(id) {
    const alerts = getAlerts().filter(a => a.id !== id);
    saveAlerts(alerts);
    renderAlerts();
}

function renderAlerts() {
    const alerts = getAlerts();
    const container = document.getElementById('alerts-list');

    if (alerts.length === 0) {
        container.innerHTML = '<p class="text-secondary">暂无提醒</p>';
        return;
    }

    let html = '<div class="alerts-grid">';
    alerts.forEach(a => {
        const conditionText = a.condition === 'above' ? '高于' : '低于';
        html += `
        <div class="alert-item">
            <div class="alert-stock">
                <span class="alert-name">${a.name}</span>
                <span class="alert-code">${a.code}</span>
            </div>
            <div class="alert-condition">
                ${conditionText} <strong>${a.price.toFixed(2)}</strong>
            </div>
            <button class="alert-remove" onclick="removeAlert(${a.id})">×</button>
        </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderHistory() {
    const history = getHistory();
    const container = document.getElementById('alerts-history');

    if (history.length === 0) {
        container.innerHTML = '<p class="text-secondary">暂无记录</p>';
        return;
    }

    let html = '<div class="history-list">';
    history.forEach(h => {
        const time = new Date(h.triggered).toLocaleString();
        html += `
        <div class="history-item">
            <span class="history-stock">${h.name} (${h.code})</span>
            <span class="history-msg">${h.message}</span>
            <span class="history-time">${time}</span>
        </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Check alerts against current prices
function checkAlerts() {
    const alerts = getAlerts();
    if (alerts.length === 0) return;

    alerts.forEach(a => {
        fetch('/api/stock/' + a.code + '/quote')
            .then(r => r.json())
            .then(data => {
                if (data.error || !data.price) return;

                const current = data.price;
                let triggered = false;
                let message = '';

                if (a.condition === 'above' && current >= a.price) {
                    triggered = true;
                    message = `${a.name} 已突破 ${a.price.toFixed(2)}，当前 ${current.toFixed(2)}`;
                } else if (a.condition === 'below' && current <= a.price) {
                    triggered = true;
                    message = `${a.name} 已跌破 ${a.price.toFixed(2)}，当前 ${current.toFixed(2)}`;
                }

                if (triggered) {
                    // Send notification
                    if (Notification.permission === 'granted') {
                        new Notification('价格提醒', {
                            body: message,
                            icon: '/static/img/icon.png'
                        });
                    }

                    // Add to history
                    const history = getHistory();
                    history.unshift({
                        ...a,
                        message: message,
                        triggered: new Date().toISOString(),
                        currentPrice: current
                    });
                    saveHistory(history);

                    // Remove alert
                    removeAlert(a.id);
                    renderHistory();
                }
            });
    });
}

// Show current price when entering code
document.getElementById('alert-code').addEventListener('blur', function() {
    const code = this.value.trim();
    if (/^\d{6}$/.test(code)) {
        fetch('/api/stock/' + code + '/quote')
            .then(r => r.json())
            .then(data => {
                if (data.price) {
                    document.getElementById('current-price-hint').textContent =
                        `当前价格: ${data.price.toFixed(2)}`;
                }
            });
    }
});

// Initialize
checkPermission();
renderAlerts();
renderHistory();

// Check alerts every 30 seconds
setInterval(checkAlerts, 30000);
checkAlerts();
</script>
{% endblock %}
