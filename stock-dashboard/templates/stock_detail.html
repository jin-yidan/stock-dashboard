{% extends "base.html" %}

{% block title %}{{ stock_name }} {{ stock_code }}{% endblock %}

{% block header %}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="stock-header">
        <div class="header-top">
            <a href="/" class="back-link">← 返回</a>
            <div class="header-badges">
                <span id="market-status" class="market-badge"></span>
                <span id="data-freshness" class="freshness-badge"></span>
                <span id="beijing-time" class="time-badge"></span>
            </div>
        </div>
        <div class="stock-header-row">
            <div class="stock-info">
                <div class="stock-name-row">
                    <h1>{{ stock_name }}</h1>
                    <button id="watchlist-btn" class="btn-watchlist" onclick="toggleWatchlist()">
                        <span id="watchlist-icon">☆</span> 自选
                    </button>
                </div>
                <span class="stock-code">{{ stock_code }}</span>
            </div>
            <div class="stock-price" id="price-section">
                <div class="skeleton skeleton-text xl"></div>
                <div class="skeleton skeleton-text" style="margin-top:4px;"></div>
            </div>
        </div>
    </div>

    <!-- Signal -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="signal-box" class="signal-box loading">
                <div class="signal-header-row">
                    <div class="signal-label">综合评估</div>
                    <div class="ai-section-inline">
                        <button class="ai-btn" onclick="handleAiAnalysis()" id="ai-generate-btn">AI 分析</button>
                    </div>
                </div>
                <div id="signal-value" class="signal-value">
                    <span class="loading-spinner"></span>分析中
                </div>
                <div id="signal-score" class="signal-score">--</div>
                <p id="signal-summary" class="signal-summary-text">
                    <span class="skeleton skeleton-text wide"></span>
                </p>
            </div>
            <!-- AI Analysis Result -->
            <div id="ai-result" class="ai-result" style="display:none;"></div>

            <!-- Education Context -->
            <div id="education-context" class="education-context" style="display:none;">
                <div class="edu-header">
                    <span class="edu-title">分析解读</span>
                    <button class="edu-toggle" onclick="toggleEducationContext()">收起</button>
                </div>
                <div id="edu-content">
                    <div class="edu-grid">
                        <div class="edu-card positive">
                            <div class="edu-card-title">看多因素</div>
                            <div id="edu-bullish-factors"></div>
                        </div>
                        <div class="edu-card negative">
                            <div class="edu-card-title">风险因素</div>
                            <div id="edu-bearish-factors"></div>
                        </div>
                    </div>
                    <div class="edu-action" id="edu-action"></div>
                    <div class="edu-regime" id="edu-regime"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal" style="display:none;">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <span class="modal-title">AI 分析</span>
                <button class="modal-close" onclick="hideApiKeyModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding-top:12px;">
                <input type="text" id="api-key-input" placeholder="输入 Claude API Key" class="api-key-input">
                <div id="ai-modal-error" class="ai-modal-error"></div>
                <div class="modal-actions">
                    <button class="btn-save" onclick="confirmAndAnalyze()">开始分析</button>
                    <button class="btn-clear" onclick="clearApiKey()">清除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 52-Week Indicator -->
    <div class="row mb-4" id="week52-section" style="display:none;">
        <div class="col-12">
            <div class="week52-indicator">
                <div class="week52-header">52周价格区间</div>
                <div class="week52-bar">
                    <div class="week52-fill" id="week52-fill"></div>
                    <div class="week52-marker" id="week52-marker"></div>
                </div>
                <div class="week52-labels">
                    <span id="week52-low">--</span>
                    <span id="week52-high">--</span>
                </div>
                <div class="week52-stats">
                    <div class="week52-stat">
                        <span class="week52-stat-label">距最高</span>
                        <span class="week52-stat-value down" id="week52-from-high">--</span>
                    </div>
                    <div class="week52-stat">
                        <span class="week52-stat-label">当前位置</span>
                        <span class="week52-stat-value" id="week52-position">--</span>
                    </div>
                    <div class="week52-stat">
                        <span class="week52-stat-label">距最低</span>
                        <span class="week52-stat-value up" id="week52-from-low">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Candlestick Patterns -->
    <div class="row mb-4" id="patterns-section" style="display:none;">
        <div class="col-12">
            <div class="patterns-box">
                <div class="patterns-header">
                    <span>K线形态</span>
                    <span id="patterns-signal" class="pattern-signal"></span>
                </div>
                <div id="patterns-content" class="patterns-content">
                    <span class="text-secondary small">分析中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Accuracy -->
    <div class="row mb-4" id="accuracy-section" style="display:none;">
        <div class="col-12">
            <div class="accuracy-box">
                <div class="accuracy-header">
                    <span>信号准确率</span>
                    <span class="accuracy-hint" title="基于历史数据回测，统计系统发出买/卖信号后的实际涨跌情况">ⓘ</span>
                </div>
                <div class="accuracy-content">
                    <div class="accuracy-main">
                        <span id="accuracy-value" class="accuracy-value">--</span>
                        <span class="accuracy-label">历史准确率</span>
                    </div>
                    <div class="accuracy-detail">
                        <div class="accuracy-detail-row">
                            <span class="accuracy-detail-label">回测周期</span>
                            <span id="accuracy-period" class="accuracy-detail-value">--</span>
                        </div>
                        <div class="accuracy-detail-row">
                            <span class="accuracy-detail-label">信号数量</span>
                            <span id="accuracy-signals" class="accuracy-detail-value">--</span>
                        </div>
                        <div class="accuracy-detail-row">
                            <span class="accuracy-detail-label">买入胜率</span>
                            <span id="accuracy-buy" class="accuracy-detail-value">--</span>
                        </div>
                        <div class="accuracy-detail-row">
                            <span class="accuracy-detail-label">卖出胜率</span>
                            <span id="accuracy-sell" class="accuracy-detail-value">--</span>
                        </div>
                        <div class="accuracy-detail-row">
                            <span class="accuracy-detail-label">信号期望收益</span>
                            <span id="accuracy-expected" class="accuracy-detail-value">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CZSC (Chan Theory) Analysis -->
    <div class="row mb-4" id="czsc-section" style="display:none;">
        <div class="col-12">
            <div class="czsc-box">
                <div class="czsc-header">缠论分析</div>
                <div id="czsc-content">
                    <p class="text-secondary small">正在分析...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- K-Line Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-box">
                <div class="chart-header">
                    <span class="chart-title">K线图</span>
                </div>
                <div id="kline-chart" style="height:500px;">
                    <div style="padding:2rem;text-align:center;">
                        <span class="loading-spinner"></span>
                        <span class="loading-text">加载K线数据...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Prediction -->
    <div class="row mb-4" id="ml-section" style="display:none;">
        <div class="col-12">
            <div class="ml-box">
                <div class="ml-header">
                    <span class="ml-title">模型预测 (5日)</span>
                    <span class="ml-model-info text-secondary small">集成学习模型</span>
                </div>
                <div id="ml-content">
                    <span class="loading-spinner"></span>
                    <span class="loading-text">正在分析...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Fundamental Data -->
    <div class="row mb-4" id="fundamental-section" style="display:none;">
        <div class="col-12">
            <div class="fundamental-box">
                <div class="fundamental-header">基本面</div>
                <div id="fundamental-content"></div>
            </div>
        </div>
    </div>

    <!-- Risk Management -->
    <div class="row mb-5">
        <div class="col-12">
            <div id="risk-section" class="risk-box" style="display:none;">
                <div class="risk-header">风险管理建议</div>
                <div class="risk-row">
                    <div class="risk-item">
                        <span class="risk-label">止损价</span>
                        <span class="risk-value down" id="stop-loss">--</span>
                        <span class="risk-pct" id="stop-pct"></span>
                    </div>
                    <div class="risk-item">
                        <span class="risk-label">目标价</span>
                        <span class="risk-value up" id="take-profit">--</span>
                        <span class="risk-pct" id="profit-pct"></span>
                    </div>
                    <div class="risk-item">
                        <span class="risk-label">波动率(ATR)</span>
                        <span class="risk-value" id="atr-value">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CYQ Chip Distribution (筹码分布) -->
    <div class="row mb-4" id="cyq-section" style="display:none;">
        <div class="col-12">
            <div class="cyq-box">
                <div class="cyq-header">
                    <span class="cyq-title">筹码分布</span>
                    <span class="cyq-subtitle text-secondary small">机构级成本分析</span>
                </div>
                <div id="cyq-content">
                    <div class="cyq-row">
                        <div class="cyq-item">
                            <span class="cyq-label">获利比例</span>
                            <span class="cyq-value" id="cyq-benefit">--%</span>
                        </div>
                        <div class="cyq-item">
                            <span class="cyq-label">平均成本</span>
                            <span class="cyq-value" id="cyq-avg-cost">--</span>
                        </div>
                        <div class="cyq-item">
                            <span class="cyq-label">70%筹码区间</span>
                            <span class="cyq-value" id="cyq-70-range">--</span>
                        </div>
                        <div class="cyq-item">
                            <span class="cyq-label">集中度</span>
                            <span class="cyq-value" id="cyq-concentration">--</span>
                        </div>
                    </div>
                    <div class="cyq-signal" id="cyq-signal-text"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Strategies -->
    <div class="row mb-4" id="strategy-section" style="display:none;">
        <div class="col-12">
            <div class="strategy-box">
                <div class="strategy-header">
                    <span class="strategy-title">策略信号</span>
                    <span class="strategy-subtitle text-secondary small">专业交易策略</span>
                </div>
                <div id="strategy-content"></div>
            </div>
        </div>
    </div>

    <!-- Indicators -->
    <div class="row">
        <div class="col-12">
            <div class="section-title-header">技术指标</div>
            <table class="indicator-table">
                <thead>
                    <tr>
                        <th>指标</th>
                        <th>信号</th>
                        <th class="text-end">贡献</th>
                    </tr>
                </thead>
                <tbody id="indicators-body">
                    <tr><td><span class="skeleton skeleton-text"></span></td><td><span class="skeleton skeleton-text"></span></td><td><span class="skeleton skeleton-text"></span></td></tr>
                    <tr><td><span class="skeleton skeleton-text"></span></td><td><span class="skeleton skeleton-text"></span></td><td><span class="skeleton skeleton-text"></span></td></tr>
                    <tr><td><span class="skeleton skeleton-text"></span></td><td><span class="skeleton skeleton-text"></span></td><td><span class="skeleton skeleton-text"></span></td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.staticfile.org/echarts/5.4.3/echarts.min.js"></script>
<script>if(typeof echarts==='undefined')document.write('<script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"><\/script>')</script>
<script>if(typeof echarts==='undefined')document.write('<script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"><\/script>')</script>
<script src="{{ url_for('static', filename='js/new-features.js') }}"></script>
<script>
const stockCode = '{{ stock_code }}';
window.stockCode = stockCode;  // Make available to new-features.js
const stockName = '{{ stock_name }}';
let klineChart = null;

// HTML escape helper to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Fetch with timeout helper
function fetchWithTimeout(url, options = {}, timeout = 90000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);

    return fetch(url, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(timeoutId));
}

// Watchlist functions
function getWatchlist() {
    const data = localStorage.getItem('watchlist');
    return data ? JSON.parse(data) : [];
}

function saveWatchlist(list) {
    localStorage.setItem('watchlist', JSON.stringify(list));
}

function isInWatchlist() {
    return getWatchlist().some(s => s.code === stockCode);
}

function updateWatchlistBtn() {
    const btn = document.getElementById('watchlist-btn');
    const icon = document.getElementById('watchlist-icon');
    if (isInWatchlist()) {
        btn.classList.add('active');
        icon.textContent = '★';
    } else {
        btn.classList.remove('active');
        icon.textContent = '☆';
    }
}

function toggleWatchlist() {
    let list = getWatchlist();
    if (isInWatchlist()) {
        list = list.filter(s => s.code !== stockCode);
    } else {
        list.unshift({ code: stockCode, name: stockName });
    }
    saveWatchlist(list);
    updateWatchlistBtn();
}

// Load signal data
function loadSignalData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/signal', {}, 90000)
        .then(r => r.json())
        .then(data => {
            console.log('Signal data:', data);  // Debug

            // Check for error or no data
            if (data.error || data.signal_cn === '无数据') {
                document.getElementById('signal-value').textContent = '暂无数据';
                document.getElementById('signal-summary').textContent = '无法获取该股票数据，请检查股票代码是否正确';
                return;
            }

            // Update signal box with fade-in
            const box = document.getElementById('signal-box');
            box.className = 'signal-box ' + data.signal + ' fade-in';
            box.classList.remove('loading');
            document.getElementById('signal-value').textContent = data.signal_cn;
            document.getElementById('signal-score').textContent = Math.round(data.score * 100) + ' / 100';
            // Use textContent for simple_summary to prevent XSS
            document.getElementById('signal-summary').textContent = data.simple_summary || '';
            document.getElementById('signal-summary').classList.add('fade-in');

            // Update indicators with education content
            const tbody = document.getElementById('indicators-body');
            tbody.innerHTML = data.indicators.map((ind, idx) => {
                const signalText = ind.signal === 'bullish' ? '看涨' : (ind.signal === 'bearish' ? '看跌' : '中性');
                const scoreClass = ind.weighted_score > 0 ? 'up' : (ind.weighted_score < 0 ? 'down' : '');
                const scorePrefix = ind.weighted_score > 0 ? '+' : '';

                // Build education content if available (escape all user data)
                let eduHtml = '';
                if (ind.education) {
                    const edu = ind.education;
                    eduHtml = `
                        <div class="indicator-education" id="edu-${idx}" style="display:none;">
                            ${edu.what_it_measures ? `<div class="edu-section"><strong>指标含义：</strong>${escapeHtml(edu.what_it_measures)}</div>` : ''}
                            ${edu.how_to_read && edu.how_to_read.length > 0 ? `
                                <div class="edu-section"><strong>如何解读：</strong>
                                    <ul>${edu.how_to_read.map(h => `<li>${escapeHtml(h)}</li>`).join('')}</ul>
                                </div>
                            ` : ''}
                            ${edu.tips && edu.tips.length > 0 ? `
                                <div class="edu-section"><strong>使用技巧：</strong>
                                    <ul>${edu.tips.map(t => `<li>${escapeHtml(t)}</li>`).join('')}</ul>
                                </div>
                            ` : ''}
                            ${edu.accuracy_note ? `<div class="edu-note">${escapeHtml(edu.accuracy_note)}</div>` : ''}
                        </div>
                    `;
                }

                return `
                    <tr>
                        <td>
                            <div class="indicator-name-row">
                                <span>${escapeHtml(ind.name)}</span>
                                ${ind.education ? `<button class="learn-btn" onclick="toggleEducation(${idx})">展开</button>` : ''}
                            </div>
                            <div class="explain">${escapeHtml(ind.plain_explanation)}</div>
                            ${eduHtml}
                        </td>
                        <td>
                            <span class="signal-tag ${ind.signal}">${signalText}</span>
                        </td>
                        <td class="text-end ${scoreClass}">
                            ${scorePrefix}${(ind.weighted_score * 100).toFixed(1)}
                        </td>
                    </tr>
                `;
            }).join('');

            // Show education context section if available
            if (data.education) {
                showEducationContext(data.education);
            }

            // Update risk management section
            if (data.stop_loss && data.take_profit) {
                document.getElementById('stop-loss').textContent = data.stop_loss.toFixed(2);
                document.getElementById('take-profit').textContent = data.take_profit.toFixed(2);
                if (data.risk_info) {
                    document.getElementById('stop-pct').textContent = `(${data.risk_info.stop_pct}%)`;
                    document.getElementById('profit-pct').textContent = `(+${data.risk_info.profit_pct}%)`;
                    document.getElementById('atr-value').textContent = `${data.risk_info.atr} (${data.risk_info.atr_pct}%)`;
                }
                document.getElementById('risk-section').style.display = 'block';
            }
            // Note: ML, CZSC, and fundamental data are loaded in parallel at page init
        })
        .catch(err => {
            console.error('Error loading signal:', err);
            document.getElementById('signal-value').textContent = '加载失败';
            const isTimeout = err.name === 'AbortError';
            document.getElementById('signal-summary').textContent = isTimeout ? '请求超时，请刷新重试' : '网络错误，请刷新重试';
        });
}

// Show ML prediction - simplified to only show rise/fall
function showMLPrediction(ml) {
    const predClass = ml.prediction === 'bullish' ? 'up' : 'down';
    const predText = ml.prediction === 'bullish' ? '看涨' : '看跌';
    const confidence = ml.confidence;
    const confidenceText = confidence >= 70 ? '较高' : (confidence >= 55 ? '中等' : '较低');

    document.getElementById('ml-content').innerHTML = `
        <div class="ml-prediction fade-in">
            <span class="ml-value ${predClass}">${predText}</span>
            <span class="ml-confidence">${confidenceText}置信 (${confidence}%)</span>
        </div>
    `;
}

// Load ML prediction (auto train if needed)
function loadMLPrediction() {
    document.getElementById('ml-section').style.display = 'block';
    document.getElementById('ml-content').innerHTML = '<span class="loading-spinner"></span><span class="loading-text">正在分析...</span>';

    // First try to predict with existing model
    fetchWithTimeout('/api/stock/' + stockCode + '/ml/predict', {}, 90000)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                // No model, need to train first
                document.getElementById('ml-content').innerHTML = '<p class="text-secondary small">训练模型中...</p>';
                return fetch('/api/stock/' + stockCode + '/ml/train')
                    .then(r => r.json())
                    .then(trainData => {
                        if (trainData.error) {
                            document.getElementById('ml-content').innerHTML =
                                '<p class="text-secondary small">数据不足，无法预测</p>';
                            return null;
                        }
                        // Now predict
                        return fetch('/api/stock/' + stockCode + '/ml/predict').then(r => r.json());
                    });
            }
            return data;
        })
        .then(pred => {
            if (pred && !pred.error) {
                showMLPrediction(pred);
            }
        })
        .catch(err => {
            document.getElementById('ml-content').innerHTML = '<p class="text-secondary small">预测失败</p>';
        });
}

// Load fundamental data
function loadFundamentalData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/fundamental', {}, 90000)
        .then(r => r.json())
        .then(data => {
            if (data && data.has_data) {
                showFundamental(data);
            }
        })
        .catch(err => {
            console.error('Error loading fundamental:', err);
        });
}

// Show fundamental data
function showFundamental(fund) {
    document.getElementById('fundamental-section').style.display = 'block';

    let html = '<div class="fundamental-grid fade-in">';

    if (fund.market_cap_yi) {
        html += `<div class="fund-item"><span class="fund-label">市值</span><span class="fund-value">${escapeHtml(String(fund.market_cap_yi))}亿</span></div>`;
    }
    if (fund.industry) {
        html += `<div class="fund-item"><span class="fund-label">行业</span><span class="fund-value">${escapeHtml(fund.industry)}</span></div>`;
    }
    if (fund.has_dividend !== undefined) {
        html += `<div class="fund-item"><span class="fund-label">分红</span><span class="fund-value">${fund.has_dividend ? '有 ('+fund.dividend_count+'次)' : '无'}</span></div>`;
    }

    html += '</div>';

    if (fund.reasons && fund.reasons.length > 0) {
        html += '<div class="fund-reasons">';
        fund.reasons.forEach(r => {
            html += `<span class="fund-reason">${escapeHtml(r)}</span>`;
        });
        html += '</div>';
    }

    if (fund.concepts && fund.concepts.length > 0) {
        // Remove duplicates
        const uniqueConcepts = [...new Set(fund.concepts)];
        html += '<div class="fund-concepts-section">';
        html += '<span class="fund-concepts-label">概念板块</span>';
        html += '<div class="fund-concepts-list">';
        uniqueConcepts.forEach(c => {
            html += `<span class="fund-concept-tag">${escapeHtml(c)}</span>`;
        });
        html += '</div></div>';
    }

    document.getElementById('fundamental-content').innerHTML = html;
}

// Load CZSC (Chan Theory) data
function loadCzscData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/czsc', {}, 90000)
        .then(r => r.json())
        .then(data => {
            if (!data.available) {
                // CZSC not available, keep section hidden
                return;
            }

            // Show CZSC section
            document.getElementById('czsc-section').style.display = 'block';

            const signal = data.signal;
            const signalCn = signal === 'bullish' ? '看多' : (signal === 'bearish' ? '看空' : '中性');
            const signalClass = signal === 'bullish' ? 'up' : (signal === 'bearish' ? 'down' : '');
            const biDirection = data.bi_direction_cn || '未知';
            const biCount = data.bi_count || 0;
            const buyPoint = data.buy_point_type;
            const sellPoint = data.sell_point_type;

            let html = '<div class="czsc-signal">';
            html += `<span class="czsc-value ${signalClass}">缠论${signalCn}</span>`;

            if (buyPoint) {
                html += `<span class="czsc-point buy">${escapeHtml(buyPoint)}</span>`;
            } else if (sellPoint) {
                html += `<span class="czsc-point sell">${escapeHtml(sellPoint)}</span>`;
            }

            html += '</div>';

            html += '<div class="czsc-details">';
            html += `<div class="czsc-item"><span class="czsc-label">当前笔方向</span><span class="czsc-val">${escapeHtml(biDirection)}</span></div>`;
            html += `<div class="czsc-item"><span class="czsc-label">笔数量</span><span class="czsc-val">${biCount}</span></div>`;
            html += '</div>';

            // Show analysis notes if available
            if (data.analysis && data.analysis.length > 0) {
                html += '<div class="czsc-analysis">';
                data.analysis.forEach(note => {
                    html += `<span class="czsc-note">${escapeHtml(note)}</span>`;
                });
                html += '</div>';
            }

            document.getElementById('czsc-content').innerHTML = html;
        })
        .catch(err => {
            console.error('Error loading CZSC:', err);
            // Keep section hidden on error
        });
}

// Load quote data
function loadQuoteData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/quote', {}, 90000)
        .then(r => r.json())
        .then(data => {
            if (!data || data.error) {
                document.getElementById('price-section').innerHTML = '<div class="text-secondary">暂无行情</div>';
                return;
            }

            const priceClass = data.change_pct >= 0 ? 'up' : 'down';
            const changePrefix = data.change_pct >= 0 ? '+' : '';
            document.getElementById('price-section').innerHTML = `
                <div class="price ${priceClass} fade-in">${data.price.toFixed(2)}</div>
                <div class="change ${priceClass} fade-in">${changePrefix}${data.change_pct.toFixed(2)}%</div>
            `;
        })
        .catch(err => {
            console.error('Error loading quote:', err);
            document.getElementById('price-section').innerHTML = '<div class="text-secondary">行情获取失败</div>';
        });
}

// Load K-line chart
function loadKline(days) {
    // Check if ECharts is loaded
    if (typeof echarts === 'undefined') {
        document.getElementById('kline-chart').innerHTML = '<p class="text-secondary p-4">图表组件加载中，请稍候...</p>';
        setTimeout(function() { loadKline(days); }, 500);
        return;
    }

    // Update button states
    document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(days)) btn.classList.add('active');
    });

    document.getElementById('kline-chart').innerHTML = '<div style="padding:2rem;text-align:center;"><span class="loading-spinner"></span><span class="loading-text">加载K线数据...</span></div>';

    // Use XMLHttpRequest for better compatibility
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/stock/' + stockCode + '/kline?days=' + days, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.error || !data.dates || data.dates.length === 0) {
                        document.getElementById('kline-chart').innerHTML = '<p class="text-secondary p-4">暂无K线数据</p>';
                        return;
                    }
                    renderKlineChart(data);
                } catch (e) {
                    console.error('JSON parse error:', e);
                    document.getElementById('kline-chart').innerHTML = '<p class="text-secondary p-4">数据解析失败</p>';
                }
            } else {
                document.getElementById('kline-chart').innerHTML = '<p class="text-secondary p-4">K线数据加载失败</p>';
            }
        }
    };
    xhr.onerror = function() {
        document.getElementById('kline-chart').innerHTML = '<p class="text-secondary p-4">网络错误</p>';
    };
    xhr.send();
}

function renderKlineChart(data) {
    const chartDom = document.getElementById('kline-chart');
    if (!klineChart) {
        klineChart = echarts.init(chartDom);
    }

    const upColor = '#ef5350';
    const downColor = '#26a69a';

    const option = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' },
            formatter: function(params) {
                const kline = params.find(p => p.seriesName === 'K线');
                if (!kline) return '';
                // Data can be array or object with value property
                let d = kline.data.value || kline.data;
                if (!d || !Array.isArray(d)) return '';
                // ECharts adds index as first element, skip it if array has 5 elements
                if (d.length === 5) {
                    d = d.slice(1);  // Remove the index, keep [open, close, low, high]
                }
                // Fix swapped high/low at display time
                const low = Math.min(d[2], d[3]);
                const high = Math.max(d[2], d[3]);
                // Display in traditional OHLC order (开高低收)
                return `${kline.axisValue}<br/>
                    开盘: ${d[0]}<br/>
                    最高: ${high}<br/>
                    最低: ${low}<br/>
                    收盘: ${d[1]}`;
            }
        },
        legend: {
            data: ['K线', 'MA5', 'MA10', 'MA20'],
            top: 10,
            left: 'center',
            textStyle: { fontSize: 11 }
        },
        grid: [
            { left: '8%', right: '3%', top: '12%', height: '55%' },
            { left: '8%', right: '3%', top: '72%', height: '18%' }
        ],
        xAxis: [
            {
                type: 'category',
                data: data.dates,
                scale: true,
                boundaryGap: true,
                axisLine: { lineStyle: { color: '#ccc' } },
                axisLabel: { fontSize: 10 },
                splitLine: { show: false }
            },
            {
                type: 'category',
                gridIndex: 1,
                data: data.dates,
                axisLabel: { show: false },
                axisLine: { show: false },
                axisTick: { show: false },
                splitLine: { show: false }
            }
        ],
        yAxis: [
            {
                scale: true,
                splitArea: { show: false },
                axisLine: { lineStyle: { color: '#ccc' } },
                axisLabel: { fontSize: 10 },
                splitLine: { lineStyle: { color: '#f0f0f0' } }
            },
            {
                gridIndex: 1,
                splitNumber: 2,
                axisLabel: { show: false },
                axisLine: { show: false },
                axisTick: { show: false },
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 },
            { type: 'slider', xAxisIndex: [0, 1], start: 50, end: 100, height: 20, bottom: 5 }
        ],
        series: [
            {
                name: 'K线',
                type: 'candlestick',
                data: data.kline,
                itemStyle: {
                    color: upColor,
                    color0: downColor,
                    borderColor: upColor,
                    borderColor0: downColor
                }
            },
            {
                name: 'MA5',
                type: 'line',
                data: data.ma5,
                smooth: true,
                showSymbol: false,
                lineStyle: { width: 1, color: '#f0a' }
            },
            {
                name: 'MA10',
                type: 'line',
                data: data.ma10,
                smooth: true,
                showSymbol: false,
                lineStyle: { width: 1, color: '#0af' }
            },
            {
                name: 'MA20',
                type: 'line',
                data: data.ma20,
                smooth: true,
                showSymbol: false,
                lineStyle: { width: 1, color: '#fa0' }
            },
            {
                name: '成交量',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                data: data.volume,
                barWidth: '60%'
            }
        ]
    };

    klineChart.setOption(option);
}

// Handle window resize
window.addEventListener('resize', function() {
    if (klineChart) klineChart.resize();
});

// Auto-refresh quote during market hours
function isMarketHours() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    if (day === 0 || day === 6) return false;
    const time = hour * 100 + minute;
    return (time >= 930 && time <= 1130) || (time >= 1300 && time <= 1500);
}

function startQuoteRefresh() {
    if (isMarketHours()) {
        setInterval(loadQuoteData, 30000);
    }
}

// Load 52-week data
function load52WeekData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/52week', {}, 90000)
        .then(r => r.json())
        .then(data => {
            if (data.error) return;

            document.getElementById('week52-section').style.display = 'block';

            // Update bar position
            document.getElementById('week52-fill').style.width = data.position + '%';
            document.getElementById('week52-marker').style.left = data.position + '%';

            // Update labels
            document.getElementById('week52-low').textContent = data.low_52w;
            document.getElementById('week52-high').textContent = data.high_52w;

            // Update stats
            document.getElementById('week52-from-high').textContent = data.pct_from_high + '%';
            document.getElementById('week52-from-low').textContent = '+' + data.pct_from_low + '%';
            document.getElementById('week52-position').textContent = data.position + '%';
        })
        .catch(err => console.error('Error loading 52-week data:', err));
}

// Load CYQ Chip Distribution data
function loadCyqData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/cyq', {}, 90000)
        .then(r => r.json())
        .then(data => {
            if (!data.available) {
                // Hide section if not available
                return;
            }

            document.getElementById('cyq-section').style.display = 'block';

            const cyqData = data.data || {};
            const signal = data.signal || {};

            // Update benefit part
            const benefitPart = cyqData.benefit_part || 0;
            const benefitEl = document.getElementById('cyq-benefit');
            benefitEl.textContent = (benefitPart * 100).toFixed(1) + '%';
            if (benefitPart < 0.3) {
                benefitEl.classList.add('up');  // Low benefit = oversold
            } else if (benefitPart > 0.8) {
                benefitEl.classList.add('down');  // High benefit = pressure
            }

            // Update avg cost
            document.getElementById('cyq-avg-cost').textContent = cyqData.avg_cost || '--';

            // Update 70% chip range
            const chips70 = cyqData.percent_chips && cyqData.percent_chips['70'];
            if (chips70 && chips70.price_range) {
                document.getElementById('cyq-70-range').textContent =
                    chips70.price_range[0] + ' - ' + chips70.price_range[1];
            }

            // Update concentration
            if (chips70 && chips70.concentration) {
                const conc = chips70.concentration;
                const concEl = document.getElementById('cyq-concentration');
                concEl.textContent = (conc * 100).toFixed(1) + '%';
                if (conc < 0.1) {
                    concEl.classList.add('up');
                    concEl.textContent += ' (集中)';
                } else if (conc > 0.2) {
                    concEl.textContent += ' (分散)';
                }
            }

            // Update signal text
            const signalEl = document.getElementById('cyq-signal-text');
            if (signal.score > 0.1) {
                signalEl.innerHTML = '<span class="signal-tag bullish">筹码看多</span>';
            } else if (signal.score < -0.1) {
                signalEl.innerHTML = '<span class="signal-tag bearish">筹码承压</span>';
            } else {
                signalEl.innerHTML = '<span class="signal-tag neutral">筹码中性</span>';
            }
        })
        .catch(err => {
            console.error('Error loading CYQ:', err);
        });
}

// Load Trading Strategies data
function loadStrategyData() {
    fetchWithTimeout('/api/stock/' + stockCode + '/strategies', {}, 90000)
        .then(r => r.json())
        .then(data => {
            const triggered = data.triggered || [];

            if (triggered.length === 0) {
                // No strategies triggered, hide section
                return;
            }

            document.getElementById('strategy-section').style.display = 'block';

            let html = '<div class="strategy-list">';
            triggered.forEach(s => {
                html += '<div class="strategy-item triggered">';
                html += '<div class="strategy-name">' + escapeHtml(s.name_cn || s.strategy) + '</div>';
                if (s.details) {
                    // Chinese labels for strategy fields
                    const fieldLabels = {
                        // 低波动增长 (low_atr)
                        'avg_daily_change': '日均波动',
                        'period_high': '10日最高',
                        'period_low': '10日最低',
                        'range_ratio': '波动幅度',
                        // 海龟突破 (turtle_trade)
                        'close': '当前价',
                        'high_60d': '60日最高',
                        'breakout_pct': '突破幅度',
                        // 回踩年线 (backtrace_ma250)
                        'highest_price': '最高价',
                        'lowest_price': '最低价',
                        'retracement': '回撤幅度',
                        'volume_ratio': '量比',
                        'ma250': '年线价',
                        // 平台突破 (platform_breakthrough)
                        'breakthrough_date': '突破日期',
                        'ma60': '60日均线',
                        // 放量跌停 (climax_limitdown)
                        'drop_pct': '跌幅',
                        'amount_yi': '成交额(亿)',
                        // 无大幅回撤 (low_backtrace_increase)
                        'gain_pct': '涨幅',
                        'start_price': '起始价',
                        'end_price': '现价',
                        'max_single_drop': '最大单日跌幅',
                        // 持续增长 (keep_increasing)
                        'ma30_growth': 'MA30增长',
                        'ma30_now': '当前MA30',
                        'ma30_30d_ago': '30日前MA30',
                    };
                    const detailItems = Object.entries(s.details).slice(0, 3);
                    html += '<div class="strategy-details">';
                    detailItems.forEach(([key, val]) => {
                        const label = fieldLabels[key] || escapeHtml(key);
                        let displayVal = typeof val === 'number' ? val.toFixed(2) : escapeHtml(String(val));
                        // Add % for percentage fields
                        if (key.includes('pct') || key.includes('change') || key.includes('ratio') || key.includes('growth') || key.includes('retracement')) {
                            displayVal += '%';
                        }
                        html += '<span class="detail-item">' + label + ': ' + displayVal + '</span>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            });
            html += '</div>';

            document.getElementById('strategy-content').innerHTML = html;
        })
        .catch(err => {
            console.error('Error loading strategies:', err);
        });
}

// Initialize - load all data in parallel for speed
updateWatchlistBtn();

// Start all API calls in parallel (don't wait for one to finish before starting others)
loadSignalData();
load52WeekData();
loadQuoteData();
loadKline(90);  // Default 90 days, user can zoom in/out
loadMLPrediction();  // Load ML prediction in parallel
loadCzscData();  // Load CZSC in parallel
loadFundamentalData();  // Load fundamental data in parallel
loadCyqData();  // Load CYQ chip distribution in parallel
loadStrategyData();  // Load trading strategies in parallel

startQuoteRefresh();

// Education functions
function toggleEducation(idx) {
    const eduDiv = document.getElementById('edu-' + idx);
    if (eduDiv) {
        const isHidden = eduDiv.style.display === 'none';
        eduDiv.style.display = isHidden ? 'block' : 'none';
        // Update button text
        const btn = eduDiv.parentElement.querySelector('.learn-btn');
        if (btn) {
            btn.textContent = isHidden ? '收起' : '展开';
        }
    }
}

function toggleEducationContext() {
    const content = document.getElementById('edu-content');
    const btn = document.querySelector('.edu-toggle');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '收起';
    } else {
        content.style.display = 'none';
        btn.textContent = '展开';
    }
}

function showEducationContext(edu) {
    const container = document.getElementById('education-context');
    if (!edu) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';

    // Show key factors (bullish)
    const bullishDiv = document.getElementById('edu-bullish-factors');
    if (edu.key_factors && edu.key_factors.length > 0) {
        bullishDiv.innerHTML = edu.key_factors.map(f => `
            <div class="factor-item">
                <span class="factor-name">${escapeHtml(f.name)}</span>
                <span class="factor-score up">+${escapeHtml(String(f.contribution))}</span>
            </div>
            <div class="factor-explain">${escapeHtml(f.explanation)}</div>
        `).join('');
    } else {
        bullishDiv.innerHTML = '<div class="no-factors">暂无明显看多信号</div>';
    }

    // Show risk factors (bearish)
    const bearishDiv = document.getElementById('edu-bearish-factors');
    if (edu.risk_factors && edu.risk_factors.length > 0) {
        bearishDiv.innerHTML = edu.risk_factors.map(f => `
            <div class="factor-item">
                <span class="factor-name">${escapeHtml(f.name)}</span>
                <span class="factor-score down">${escapeHtml(String(f.contribution))}</span>
            </div>
            <div class="factor-explain">${escapeHtml(f.explanation)}</div>
        `).join('');
    } else {
        bearishDiv.innerHTML = '<div class="no-factors">暂无明显风险信号</div>';
    }

    // Show suggested action
    const actionDiv = document.getElementById('edu-action');
    if (edu.suggested_action) {
        actionDiv.innerHTML = `<strong>建议操作：</strong>${escapeHtml(edu.suggested_action)}`;
        actionDiv.style.display = 'block';
    } else {
        actionDiv.style.display = 'none';
    }

    // Show regime education
    const regimeDiv = document.getElementById('edu-regime');
    if (edu.regime_education) {
        const re = edu.regime_education;
        regimeDiv.innerHTML = `
            <div class="regime-info">
                <strong>市场环境 - ${escapeHtml(re.name)}：</strong>${escapeHtml(re.description)}
                <div class="regime-strategy"><strong>策略建议：</strong>${escapeHtml(re.strategy)}</div>
            </div>
        `;
        regimeDiv.style.display = 'block';
    } else {
        regimeDiv.style.display = 'none';
    }
}

// ============================================
// AI Analysis Functions
// ============================================

function getApiKey() {
    return localStorage.getItem('openai_api_key') || '';
}

function saveApiKeyToStorage(key) {
    localStorage.setItem('openai_api_key', key);
}

function showApiKeyModal(errorMsg) {
    const modal = document.getElementById('api-key-modal');
    const input = document.getElementById('api-key-input');
    const errorEl = document.getElementById('ai-modal-error');
    input.value = getApiKey();
    errorEl.textContent = errorMsg || '';
    modal.style.display = 'flex';
    input.focus();
}

function hideApiKeyModal() {
    document.getElementById('api-key-modal').style.display = 'none';
    document.getElementById('ai-modal-error').textContent = '';
}

function clearApiKey() {
    saveApiKeyToStorage('');
    document.getElementById('api-key-input').value = '';
    document.getElementById('ai-modal-error').textContent = '';
}

// Entry point - show modal to confirm before analysis
function handleAiAnalysis() {
    showApiKeyModal();
}

// Save key and start analysis
function confirmAndAnalyze() {
    const key = document.getElementById('api-key-input').value.trim();
    const errorEl = document.getElementById('ai-modal-error');
    if (!key) {
        errorEl.textContent = '请输入 API Key';
        return;
    }
    saveApiKeyToStorage(key);
    hideApiKeyModal();
    generateAiAnalysis();
}

function generateAiAnalysis() {
    const apiKey = getApiKey();
    if (!apiKey) {
        showApiKeyModal();
        return;
    }

    const btn = document.getElementById('ai-generate-btn');
    const result = document.getElementById('ai-result');

    // Show loading state
    btn.textContent = '分析中...';
    btn.classList.add('loading');
    result.style.display = 'none';

    fetch('/api/stock/' + stockCode + '/ai-analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ api_key: apiKey })
    })
    .then(r => r.json())
    .then(data => {
        btn.textContent = 'AI 分析';
        btn.classList.remove('loading');

        if (data.success) {
            const formatted = formatAiAnalysis(data.analysis);
            result.innerHTML = `
                <div class="ai-result-header">
                    <span class="ai-title">分析报告</span>
                </div>
                ${formatted}
            `;
            result.style.display = 'block';
        } else {
            // Show error in modal
            showApiKeyModal(data.error);
        }
    })
    .catch(err => {
        console.error('AI analysis error:', err);
        btn.textContent = 'AI 分析';
        btn.classList.remove('loading');
        showApiKeyModal('网络错误，请重试');
    });
}

function formatAiAnalysis(text) {
    // Convert markdown to clean HTML
    let html = text
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Lists
        .replace(/^- (.*)/gm, '<li>$1</li>')
        // Paragraphs (double line breaks)
        .replace(/\n\n/g, '</p><p>')
        // Single line breaks
        .replace(/\n/g, '<br>');

    // Wrap consecutive list items
    html = html.replace(/(<li>.*?<\/li>)(<br>)?(<li>)/g, '$1$3');
    html = html.replace(/(<li>.*<\/li>)+/gs, '<ul>$&</ul>');

    // Clean up
    html = html.replace(/<p>\s*<\/p>/g, '');
    html = html.replace(/<p><br>/g, '<p>');
    html = html.replace(/<br><\/p>/g, '</p>');

    return '<div class="ai-analysis-content"><p>' + html + '</p></div>';
}

// No-op - API key status is handled by the modal

// Close modal when clicking outside
document.getElementById('api-key-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideApiKeyModal();
    }
});

</script>
{% endblock %}
